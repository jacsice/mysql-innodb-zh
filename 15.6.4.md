### 15.6.4 Doublewrite Buffer

The doublewrite buffer is a storage area where `InnoDB` writes pages flushed from the buffer pool before writing the pages to their proper positions in the `InnoDB` data files. If there is an operating system, storage subsystem, or unexpected [**mysqld**](https://dev.mysql.com/doc/refman/8.0/en/mysqld.html) process exit in the middle of a page write, `InnoDB` can find a good copy of the page from the doublewrite buffer during crash recovery.

> 双写缓冲区是一个存储区域，`InnoDB` 在将页面写入到在 `InnoDB` 数据文件中的适当位置之前，将从缓冲池刷新到其中。如果在页面写入的时候有操作系统、存储子系统或意外的[**mysqld**](https://dev.mysql.com/doc/refman/8.0/en/mysqld.html)进程退出，`InnoDB` 在崩溃恢复期间可以从双写缓冲区中找到一个可用的页面副本。

Although data is written twice, the doublewrite buffer does not require twice as much I/O overhead or twice as many I/O operations. Data is written to the doublewrite buffer in a large sequential chunk, with a single `fsync()` call to the operating system (except in the case that `innodb_flush_method` is set to `O_DIRECT_NO_FSYNC`).

> 虽然数据被写入两次，但双写缓冲区不需要两倍的 I/O 开销或两倍的 I/O 操作。数据以一个大的顺序块写入双写缓冲区，对操作系统进行一次`fsync()`调用（除非在`innodb_flush_method`设置为`O_DIRECT_NO_FSYNC`的情况下）。

Prior to MySQL 8.0.20, the doublewrite buffer storage area is located in the `InnoDB` system tablespace. As of MySQL 8.0.20, the doublewrite buffer storage area is located in doublewrite files.

> 在 MySQL 8.0.20 之前，doublewrite 缓冲区存储区位于`InnoDB` 系统表空间中。从 MySQL 8.0.20 开始，双写缓冲区存储区位于双写文件中。

The following variables are provided for doublewrite buffer configuration:

- [`innodb_doublewrite`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite)

  The [`innodb_doublewrite`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite) variable controls whether the doublwrite buffer is enabled. It is enabled by default in most cases. To disable the doublewrite buffer, set [`innodb_doublewrite`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite) to 0 or start the server with `--skip-innodb-doublewrite`. Consider disabling the doublewrite buffer if you are more concerned with performance than data integrity, as may be the case when performing benchmarks, for example.

  >[`innodb_doublewrite`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite) 变量控制是否启用双写缓冲区。在大多数情况下，它默认启用。要禁用双写缓冲区，请将 [`innodb_doublewrite`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite) 设置为 0 或使用 `--skip-innodb-doublewrite`启动服务。如果更关心性能而不是数据完整性，可以考虑禁用双写缓冲区，例如执行基准测试时。

  If the doublewrite buffer is located on a Fusion-io device that supports atomic writes, the doublewrite buffer is automatically disabled and data file writes are performed using Fusion-io atomic writes instead. However, be aware that the [`innodb_doublewrite`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite) setting is global. When the doublewrite buffer is disabled, it is disabled for all data files including those that do not reside on Fusion-io hardware. This feature is only supported on Fusion-io hardware and is only enabled for Fusion-io NVMFS on Linux. To take full advantage of this feature, an [`innodb_flush_method`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_flush_method) setting of `O_DIRECT` is recommended.

  > 如果双写缓冲区位于支持原子写入的 Fusion-io 设备上，则会自动禁用双写缓冲区，并使用 Fusion-io 原子写入执行数据文件写入。但是，请注意 [`innodb_doublewrite`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite) 设置是全局的。当双写缓冲区被禁用时，所有数据文件都被禁用，包括那些不驻留在 Fusion-io 硬件上的文件。此功能仅在 Fusion-io 硬件上受支持，并且仅在 Linux 上为 Fusion-io NVMFS 启用。要充分利用此功能，建议使用 [`innodb_flush_method`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_flush_method) 设置 `O_DIRECT`。
  >
  > 注： *Fusion*-*io是*基于NAND Flash技术的存储设备，底层存储技术与SSD相同

- [`innodb_doublewrite_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_dir)

  The [`innodb_doublewrite_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_dir) variable (introduced in MySQL 8.0.20) defines the directory where `InnoDB` creates doublewrite files. If no directory is specified, doublewrite files are created in the [`innodb_data_home_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_data_home_dir) directory, which defaults to the data directory if unspecified.

  A hash symbol '#' is automatically prefixed to the specified directory name to avoid conflicts with schema names. However, if a '.', '#'. or '/' prefix is specified explicitly in the directory name, the hash symbol '#' is not prefixed to the directory name.

  Ideally, the doublewrite directory should be placed on the fastest storage media available.

  > [`innodb_doublewrite_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_dir) 变量（在 MySQL 8.0.20 中引入）定义了 `InnoDB` 创建双写文件的目录地址。如果未指定目录，则在 [`innodb_data_home_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_data_home_dir) 目录中创建双写文件，默认为数据目录（如果未指定）。
  >
  > 哈希符号“#”会自动作为指定目录名称的前缀，以避免与模式名称冲突。
  >
  > 理想情况下，双写目录应放置在可用的最快存储介质上。

- [`innodb_doublewrite_files`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_files)

  The [`innodb_doublewrite_files`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_files) variable defines the number of doublewrite files. By default, two doublewrite files are created for each buffer pool instance: A flush list doublewrite file and an LRU list doublewrite file.

  >[`innodb_doublewrite_files`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_files) 变量定义了双写文件的数量。默认情况下，为每个缓冲池实例创建两个双写文件：一个刷新列表双写文件和一个 LRU 列表双写文件。

  The flush list doublewrite file is for pages flushed from the buffer pool flush list. The default size of a flush list doublewrite file is the `InnoDB` page size * doublewrite page bytes.

  > 刷新列表双写文件用于存储从缓冲池刷新列表中刷新的页面。刷新列表双写文件的默认大小是 `InnoDB` 页大小 * 双写页字节。

  The LRU list doublewrite file is for pages flushed from the buffer pool LRU list. It also contains slots for single page flushes. The default size of an LRU list doublewrite file is the `InnoDB` page size * (doublewrite pages + (512 / the number of buffer pool instances)) where 512 is the total number of slots reserved for single page flushes.

  > LRU 列表双写文件用于存储从缓冲池 LRU 列表中刷新的页面。它还包含用于单页刷新的插槽。 LRU 列表双写文件的默认大小是`InnoDB`页面大小 *（双写页面 +（512 / 缓冲池实例数）），其中 512 是为单页刷新保留的插槽总数。

  At a minimum, there are two doublewrite files. The maximum number of doublewrite files is two times the number of buffer pool instances. (The number of buffer pool instances is controlled by the [`innodb_buffer_pool_instances`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_buffer_pool_instances) variable.)

  >至少有两个双写文件。双写文件的最大数量是缓冲池实例数量的两倍。 （缓冲池实例的数量由 [`innodb_buffer_pool_instances`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_buffer_pool_instances) 变量控制。）

  Doublewrite file names have the following format: `#ib_*`page_size`*_*`file_number`*.dblwr`. For example, the following doublewrite files are created for a MySQL instance with an `InnoDB` pages size of 16KB and a single buffer pool:

  >双写文件名具有以下格式：`#ib_*`page_size`*_*`file_number`*.dblwr`。例如，以下双写文件是为 `InnoDB` 页面大小为 16KB 和单个缓冲池的 MySQL 实例创建的

  ```none
  #ib_16384_0.dblwr
  #ib_16384_1.dblwr
  ```

  The [`innodb_doublewrite_files`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_files) variable is intended for advanced performance tuning. The default setting should be suitable for most users.

  >[`innodb_doublewrite_files`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_files) 变量用于高级性能调整。默认设置应该适合大多数用户。

- [`innodb_doublewrite_pages`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_pages)

  The [`innodb_doublewrite_pages`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_pages) variable (introduced in MySQL 8.0.20) controls the maximum number of doublewrite pages per thread. If no value is specified, [`innodb_doublewrite_pages`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_pages) is set to the [`innodb_write_io_threads`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_write_io_threads) value. This variable is intended for advanced performance tuning. The default value should be suitable for most users.

>[`innodb_doublewrite_pages`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_pages) 变量（在 MySQL 8.0.20 中引入）控制每个双写页面的在单个线程上的最大数量。如果未指定值，则 [`innodb_doublewrite_pages`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_pages) 设置为 [`innodb_write_io_threads`](https: //dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_write_io_threads) 值。此变量用于高级性能调整。默认值应该适合大多数用户。

- [`innodb_doublewrite_batch_size`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_batch_size)

  The [`innodb_doublewrite_batch_size`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_batch_size) variable (introduced in MySQL 8.0.20) controls the number of doublewrite pages to write in a batch. This variable is intended for advanced performance tuning. The default value should be suitable for most users.

> [`innodb_doublewrite_batch_size`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_doublewrite_batch_size) 变量（在 MySQL 8.0.20 中引入）控制批量写入的双写页数。此变量用于高级性能调整。默认值应该适合大多数用户。

As of MySQL 8.0.23, `InnoDB` automatically encrypts doublewrite file pages that belong to encrypted tablespaces (see [Section 15.13, “InnoDB Data-at-Rest Encryption”](https://dev.mysql.com/doc/refman/8.0/en/innodb-data-encryption.html)). Likewise, doublewrite file pages belonging page-compressed tablespaces are compressed. As a result, doublewrite files can contain different page types including unencrypted and uncompressed pages, encrypted pages, compressed pages, and pages that are both encrypted and compressed.

> 从 MySQL 8.0.23 开始，`InnoDB` 会自动加密属于加密表空间的双写文件页面。同样，属于页压缩表空间的双写文件页也被压缩。因此，双写文件可以包含不同的页面类型，包括未加密和未压缩的页面、加密的页面、压缩的页面以及加密和压缩的页面。